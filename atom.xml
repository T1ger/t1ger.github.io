<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>t1ger的茶馆</title>
  <subtitle>头顶有光终是幻，足下生云未是仙</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://t1ger.github.io/"/>
  <updated>2019-07-25T06:56:20.423Z</updated>
  <id>https://t1ger.github.io/</id>
  
  <author>
    <name>t1ger</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>如何进行jvm故障排查定位</title>
    <link href="https://t1ger.github.io/2019/07/25/%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8Cjvm%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E5%AE%9A%E4%BD%8D/"/>
    <id>https://t1ger.github.io/2019/07/25/如何进行jvm故障排查定位/</id>
    <published>2019-07-25T05:01:33.000Z</published>
    <updated>2019-07-25T06:56:20.423Z</updated>
    
    <content type="html"><![CDATA[<h3 id="故障类型分析"><a href="#故障类型分析" class="headerlink" title="故障类型分析"></a><b>故障类型分析</b></h3><p>线上的jvm故障基本可以分为两大类:</p>
<ul>
<li>CPU占用过高</li>
<li>内存问题,通常可以理解为gc的问题,因为java的内存有gc进行管理.</li>
</ul>
<h3 id="故障排查兵器谱"><a href="#故障排查兵器谱" class="headerlink" title="故障排查兵器谱"></a><b>故障排查兵器谱</b></h3><p>命令行工具<br>jps等工具都是对tools.jar类的包装,使用起来方便简单.在下边的故障排查中会用到我们这里提到的工具,大家平时应该熟记于心.</p>
<ul>
<li>top</li>
<li><p>jps: JVM Process Status Tool，显示指定系统内所有的HotSpot虚拟机进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jps </span><br><span class="line">jps -l pid #输出主类的全名，如果进程执行的是jar包，输出jar包路径</span><br><span class="line">jps -v pid #输出虚拟机进程启动时JVM参数</span><br></pre></td></tr></table></figure>
</li>
<li><p>jstat: JVM Statistics Monitoring Tool，用于收集HotSpot虚拟机各方面的运行数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#我想监控gc，每250ms查询一次，一共查询20次，进程号为123</span><br><span class="line">jstat -gc 123 250 20</span><br></pre></td></tr></table></figure>
</li>
<li><p>jinfo: Configuration Info for Java，显示虚拟机配置信息</p>
</li>
<li><p>jmap: Memory Map for Java，生成虚拟机的内存转储快照(heap dump文件),jmap dump文件的时候会触发 FGC ，使用的时候注意场景)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jmap pid</span><br><span class="line">jmap -histo:live pid &gt; a.log  #当前Java进程创建的活跃对象数目和占用内存大小</span><br><span class="line">jmap -dump:live, format=b,file=xxx.xxx pid #当前Java进程的内存占用情况导出来</span><br></pre></td></tr></table></figure>
</li>
<li><p>jstack: Stack Trace for Java，显示虚拟机的线程快照</p>
</li>
</ul>
<p>图形工具</p>
<ul>
<li>jconsole: JVM各状态查看工具</li>
<li>visualVM</li>
</ul>
<h3 id="CPU问题"><a href="#CPU问题" class="headerlink" title="CPU问题"></a>CPU问题</h3><p>CPU负载比较高的时候,我们需要先找到那个java进程,然后根据找到的那个”问题线程”,根据线程的堆栈信息找到代码,最后进行代码排查</p>
<ul>
<li>top命令定位到cpu消耗最高的进程,并记住进程pid</li>
<li>通过 top -Hp pid 找到问题线程,记住线程 tid</li>
<li>通过jstack -l tid &gt;jstack.log 将线程堆栈信息dump到指定文件中</li>
<li>线程tid 是十进制的,堆栈中的线程id是16进制,使用 printf “%x\n” tid 转化</li>
<li>通过转化的16进制数字从堆栈信息中找到对应的线程堆栈.</li>
<li>如果有gc线程,可以推断内存泄露导致频发的gc,可以通过 jstat -gcutil pid 1s查看<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# jstat -gcutil 27534 1s    </span><br><span class="line">  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT   </span><br><span class="line"> 0.00   0.00  100.00  99.34  91.25  82.89  52648  463.968   1439   3701.045  3473.868</span><br><span class="line">  0.00  0.00   89.65  99.34  91.25  82.89  52649  463.975   1440   3711.702  3476.880</span><br><span class="line">  0.00  0.00  100.00  99.34  91.25  82.89  52649  463.975   1440   3711.702  3476.880</span><br><span class="line">  0.00  0.00  100.00   99.34  91.25  82.89  52649  463.975  1443   3714.241  3479.891</span><br><span class="line">  0.00  0.00  100.00  99.34  91.25  82.89  52649  463.975   1443   3714.241 3479.891</span><br><span class="line">  0.00  0.00  100.00  99.34  91.25  82.89  52649  463.975   1443   3714.241  3479.891</span><br><span class="line">  0.00  0.00  100.00  99.34  91.25  82.89  52649  463.975   1444   3719.604  3483.889</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>可以看到每隔几秒就会full gc，而且Eden和Old都是99%，就是说每次full gc都没有回收到多少内存，所以一直在反复的跑</p>
<p>jinfo用来查看运行中的虚拟机的参数,甚至在运行时动态修改一些JVM参数,选项-XX:+PrintFlagsFinal可以列出所有的JVM flag,而其中的标注为manageable的flag则是可通过JDK management interface(-XX:+PrintFlagsFinal)动态修改<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# java -XX:+PrintFlagsFinal -version | grep manageable</span><br><span class="line">     intx CMSAbortablePrecleanWaitMillis            = 100                                 &#123;manageable&#125;</span><br><span class="line">     intx CMSTriggerInterval                        = -1                                  &#123;manageable&#125;</span><br><span class="line">     intx CMSWaitDuration                           = 2000                                &#123;manageable&#125;</span><br><span class="line">     bool HeapDumpAfterFullGC                       = false                               &#123;manageable&#125;</span><br><span class="line">     bool HeapDumpBeforeFullGC                      = false                               &#123;manageable&#125;</span><br><span class="line">     bool HeapDumpOnOutOfMemoryError                = false                               &#123;manageable&#125;</span><br><span class="line">    ccstr HeapDumpPath                              =                                     &#123;manageable&#125;</span><br><span class="line">    uintx MaxHeapFreeRatio                          = 100                                 &#123;manageable&#125;</span><br><span class="line">    uintx MinHeapFreeRatio                          = 0                                   &#123;manageable&#125;</span><br><span class="line">     bool PrintClassHistogram                       = false                               &#123;manageable&#125;</span><br><span class="line">     bool PrintClassHistogramAfterFullGC            = false                               &#123;manageable&#125;</span><br><span class="line">     bool PrintClassHistogramBeforeFullGC           = false                               &#123;manageable&#125;</span><br><span class="line">     bool PrintConcurrentLocks                      = false                               &#123;manageable&#125;</span><br><span class="line">     bool PrintGC                                   = false                               &#123;manageable&#125;</span><br><span class="line">     bool PrintGCDateStamps                         = false                               &#123;manageable&#125;</span><br><span class="line">     bool PrintGCDetails                            = false                               &#123;manageable&#125;</span><br><span class="line">     bool PrintGCID                                 = false                               &#123;manageable&#125;</span><br><span class="line">     bool PrintGCTimeStamps                         = false                               &#123;manageable&#125;</span><br><span class="line">java version &quot;1.8.0_112&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_112-b15)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.112-b15, mixed mode)</span><br></pre></td></tr></table></figure></p>
<p>用jinfo打开以下选项，把full gc前后的虚拟机内存dump下来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jinfo -flag +PrintGC pid</span><br><span class="line">jinfo -flag +PrintGCDetails pid</span><br><span class="line">jinfo -flag HeapDumpPath=/home/rain/heapdump pid</span><br><span class="line">jinfo -flag +HeapDumpBeforeFullGC pid</span><br><span class="line">jinfo -flag +HeapDumpAfterFullGC pid</span><br></pre></td></tr></table></figure></p>
<p>PrintGC和PrintGCDetails把gc日志输出到了nohup.out，查看nohup文件，可以看到full gc前后各dump了一次虚拟机内存，然后赶紧用jinfo关掉gc选项，选项前+号表示打开，-号表示关闭.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jinfo -flag -HeapDumpBeforeFullGC pid</span><br><span class="line">jinfo -flag -HeapDumpAfterFullGC pid</span><br></pre></td></tr></table></figure></p>
<p>在HeapDumpPath下找到dump下来的hprof文件,下载下来用Jprofile，jvisualvm 等工具都可以分析</p>
<h3 id="内存问题"><a href="#内存问题" class="headerlink" title="内存问题"></a>内存问题</h3><p>这里简单的说下,在java虚拟机中,内存分为: 新生代(Eden), 老年代(Old),永久代.<br>新生代存放朝生夕死的对象<br>老年代存放从新生代迁移过来的周期较久的对象.<br>永久代是非堆内存的组成部分.主要存放加载类的class类级对象,比如说class本身,method,field等等</p>
<p>在进行内存问题处理的时候,我们经常会碰到以下两种异常:<br>java.lang.OutOfMemoryError: PermGen space<br>如果出现这个异常,一般都是程序启动需要加载大量的第三方jar包,需要调整perm的内存设置<br>java.lang.OutOfMemoryError: Java heap space<br>如果出现这个异常,一般是由于虚拟机设置堆内存过小或者代码创建了大量的大对象,并且长时间不能被回收.</p>
<p>通常gc管理内存,一种是内存溢出,一种是内存没有溢出,gc处于亚健康情况<br>内存溢出的情况可以通过加上 -XX:+HeapDumpOnOutOfMemoryError 参数，该参数作用是：在程序内存溢出时输出 dump 文件</p>
<p>内存不溢出的情况比较复杂,一般gc会将内存分为一块较大的Eden空间和两块较小的Survivor空间,每次使用Eden和其中的一块Survivor.当回收时,将Eden和Survivor中还存活着的对象一次性拷贝到另外一块Survivor空间上,最后清理掉Eden和刚才用过的Survivor的空间.HotSpot虚拟机默认Eden和Survivor的大小比例是8:1</p>
<p>YGC会经过两个过程,一个是扫描,一个是复制,扫描比较快,复制相对慢一些,如果每次都有大量的对象复制,STW(stop the world)时间会延长,另外一种情况是gc和系统的swap同时进行,也会延长STW时间<br>FGC触发原因有以下几个方面:<br>1.Old区内存不足<br>2.元数据区内存不足<br>3.cms promotion failed<br>4.concurrent mode failure.<br>5.jvm基于悲观策略认为ygc后old区无法放下晋升对象<br>6.jmap触发或者系统触发System.gc()</p>
<p>一般gc健康的情况下,YGC 5秒一次左右，每次不超过50毫秒，FGC 最好没有，CMS GC 一天一次左右<br>gc超过5秒,说明系统内存过大,如果YGC频率过高,说明Eden区过小,可以增加Eden去</p>
<p>内存问题的排查思路和cpu类似,在进行cpu分析的时候也顺带说了下内存:</p>
<ul>
<li>通过top命令定位内存消耗最高的进程,并记住进程pid</li>
<li>jmap -histo:live pid查看当前进程创建的活跃对象的数目和占用内存的大小,从而定位代码</li>
</ul>
<p>对于一般的问题，通过这几个方面的思考，大致可以锁定问题所在，或是缩小问题可能发生的范围。例如对某些特定类型的内存泄漏来说，到这一步已经可以分析出是什么类型导致内存泄漏</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;故障类型分析&quot;&gt;&lt;a href=&quot;#故障类型分析&quot; class=&quot;headerlink&quot; title=&quot;故障类型分析&quot;&gt;&lt;/a&gt;&lt;b&gt;故障类型分析&lt;/b&gt;&lt;/h3&gt;&lt;p&gt;线上的jvm故障基本可以分为两大类:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;CPU占用过高&lt;/li&gt;
&lt;l
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>How to Write Rules for Prometheus</title>
    <link href="https://t1ger.github.io/2019/06/06/How-to-Write-Rules-for-Prometheus/"/>
    <id>https://t1ger.github.io/2019/06/06/How-to-Write-Rules-for-Prometheus/</id>
    <published>2019-06-06T06:51:03.000Z</published>
    <updated>2019-06-14T09:51:02.213Z</updated>
    
    <content type="html"><![CDATA[<p>First thing you should know is that there are two types of rules in Prometheus:</p>
<ul>
<li>Recoding rules</li>
<li>Alerting rules</li>
</ul>
<p>Rules are evaluated at regular intervals, and they can be included in prometheus.yml configuration file with the following line:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rule_files:</span><br><span class="line">  - /etc/prometheus/rules/*.rules</span><br></pre></td></tr></table></figure></p>
<h5 id="Recording-Rules"><a href="#Recording-Rules" class="headerlink" title="Recording Rules"></a><b>Recording Rules</b></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: recording_rules</span><br><span class="line">  interval: 5s</span><br><span class="line">  rules:</span><br><span class="line">    - record: asia_shanghai_time</span><br><span class="line">      expr: time()</span><br><span class="line">    - record: asia_shanghai_hour</span><br><span class="line">      expr:  hour(asia_shanghai_time)+8</span><br><span class="line">- name: School Http Status Check</span><br><span class="line">  rules:</span><br><span class="line">  - alert: Http School Check Status</span><br><span class="line">    expr: probe_success&#123;job=&quot;blackbox-school-http&quot;&#125; == 0 and ON() asia_shanghai_hour &gt;= 6 &lt; 22</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning </span><br><span class="line">      env: school</span><br><span class="line">    annotations:</span><br><span class="line">      description: &quot;机器:&#123;&#123; $labels.instance &#125;&#125; 所属 job:&#123;&#123; $labels.job &#125;&#125; http状态码: &#123;&#123; printf `probe_http_status_code&#123;instance=&apos;%s&apos;&#125;` $labels.instance | query | first | value &#125;&#125; http检测失败，请检查！&quot;</span><br><span class="line">      summary: &quot;http检测&quot;</span><br></pre></td></tr></table></figure>
<h5 id="Alerting-Rules"><a href="#Alerting-Rules" class="headerlink" title="Alerting Rules"></a><b>Alerting Rules</b></h5><ul>
<li><p>CPU</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: CPU报警规则</span><br><span class="line">  rules:</span><br><span class="line">  - alert: NodeCPUUsage</span><br><span class="line">    expr: 100 - (avg by (instance)(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m]) )) * 100 &gt; 80</span><br><span class="line">    for: 30m</span><br><span class="line">    labels:</span><br><span class="line">      serverity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      description: &quot;&#123;&#123;$labels.instance&#125;&#125;: High CPU usage detected&quot;</span><br><span class="line">      summary: &quot;&#123;&#123;$labels.instance&#125;&#125;: CPU usage is above 90% (current value is: &#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">  - alert: ContextSwitching</span><br><span class="line">    expr: rate(node_context_switches_total[5m]) &gt; 1000</span><br><span class="line">    for: 30m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Context switching (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Context switching is growing on node (&gt; 1000 / s)\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS: &#123;&#123; $labels &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Memory</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: 内存报警规则</span><br><span class="line">  rules:</span><br><span class="line">  - alert: NodeMemoryUsage</span><br><span class="line">    expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes+node_memory_Buffers_bytes+node_memory_Cached_bytes )) / node_memory_MemTotal_bytes * 100 &gt; 80</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning </span><br><span class="line">    annotations:</span><br><span class="line">      description: &quot;&#123;&#123;$labels.instance&#125;&#125;: Memory usage is above 80% (current value is: &#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">      summary: &quot;&#123;&#123;$labels.instance&#125;&#125;: High Memory usage detected&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Disk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: 磁盘报警规则</span><br><span class="line">  rules:</span><br><span class="line">  - alert: OutOfNodeDiskSpace</span><br><span class="line">    expr: (node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes * 100 &gt; 80</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      description: &quot;&#123;&#123;$labels.instance&#125;&#125;: Disk usage is above 80% (current value is: &#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">      summary:  &quot;&#123;&#123;$labels.instance&#125;&#125;: High Disk usage detected&quot;</span><br><span class="line">  - alert: UnusualDiskReadRate</span><br><span class="line">    expr: sum by (instance) (irate(node_disk_read_bytes_total[2m])) / 1024 / 1024 &gt; 50</span><br><span class="line">    for: 30m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Unusual disk read rate (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Disk is probably reading too much data (&gt; 50 MB/s)\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS: &#123;&#123; $labels &#125;&#125;&quot;</span><br><span class="line">  - alert: UnusualDiskWriteRate</span><br><span class="line">    expr: sum by (instance) (irate(node_disk_written_bytes_total[2m])) / 1024 / 1024 &gt; 50</span><br><span class="line">    for: 30m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Unusual disk write rate (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Disk is probably writing too much data (&gt; 50 MB/s)\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS: &#123;&#123; $labels &#125;&#125;&quot;</span><br><span class="line">  - alert: DiskWillFillIn16Hours</span><br><span class="line">    expr: predict_linear(node_filesystem_free&#123;filesystem!~&quot;^/run(/|$)&quot;,fstype!~&quot;tmpfs&quot;,mountpoint=&quot;/&quot;&#125;[1h], 16 * 3600) &lt; 0 and on(instance, job) (time() - node_installation_time_seconds &gt; 2 * 3600)</span><br><span class="line">    for: 30m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Out of inodes (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125; will be soon out of disk space.&quot;</span><br><span class="line">  - alert: UnusualDiskReadLatency</span><br><span class="line">    expr: rate(node_disk_read_time_seconds_total[1m]) / rate(node_disk_reads_completed_total[1m]) &gt; 100</span><br><span class="line">    for: 30m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Unusual disk read latency (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Disk latency is growing (read operations &gt; 100ms)\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS: &#123;&#123; $labels &#125;&#125;&quot;</span><br><span class="line">  - alert: UnusualDiskWriteLatency</span><br><span class="line">    expr: rate(node_disk_write_time_seconds_total[1m]) / rate(node_disk_writes_completed_total[1m]) &gt; 100</span><br><span class="line">    for: 30m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Unusual disk write latency (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Disk latency is growing (write operations &gt; 100ms)\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS: &#123;&#123; $labels &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Network</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: Unusual network throughput</span><br><span class="line">  rules:</span><br><span class="line">    - alert: UnusualNetworkThroughputIn</span><br><span class="line">      expr: sum by (instance) (irate(node_network_receive_bytes_total[2m])) / 1024 / 1024 &gt; 100</span><br><span class="line">      for: 30m</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">      annotations:</span><br><span class="line">        summary: &quot;Unusual network throughput in (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">        description: &quot;Host network interfaces are probably receiving too much data (&gt; 100 MB/s)\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS: &#123;&#123; $labels &#125;&#125;&quot;</span><br><span class="line">    - alert: UnusualNetworkThroughputOut</span><br><span class="line">      expr: sum by (instance) (irate(node_network_transmit_bytes_total[2m])) / 1024 / 1024 &gt; 100</span><br><span class="line">      for: 30m</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">      annotations:</span><br><span class="line">        summary: &quot;Unusual network throughput out (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">        description: &quot;Host network interfaces are probably sending too much data (&gt; 100 MB/s)\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS: &#123;&#123; $labels &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>blackbox for ssl_expiry</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">groups: </span><br><span class="line">  - name: ssl_expiry.rules </span><br><span class="line">    rules: </span><br><span class="line">    - alert: SSLCertExpiringSoon </span><br><span class="line">      expr: probe_ssl_earliest_cert_expiry&#123;job=&quot;blackbox-http&quot;&#125; - time() &lt; 86400 * 30 </span><br><span class="line">      for: 30m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">      annotations:</span><br><span class="line">        summary: &quot;SSL certificate will expire soon (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">        description: &quot;SSL certificate expires in 30 days\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS: &#123;&#123; $labels &#125;&#125;&quot;</span><br><span class="line">    - alert: SslCertificateHasExpired</span><br><span class="line">      expr: probe_ssl_earliest_cert_expiry - time()  &lt;= 0</span><br><span class="line">      for: 30m</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">      annotations:</span><br><span class="line">        summary: &quot;SSL certificate has expired (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">        description: &quot;SSL certificate has expired already\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS: &#123;&#123; $labels &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>blackbox for http</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: Http Status Check</span><br><span class="line">  rules:</span><br><span class="line">  - alert: Http Status Check</span><br><span class="line">    expr: probe_success&#123;job=&quot;blackbox-http&quot;&#125; == 0</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning </span><br><span class="line">    annotations:</span><br><span class="line">      description: &quot;机器:&#123;&#123; $labels.instance &#125;&#125; 所属 job:&#123;&#123; $labels.job &#125;&#125; http状态码: &#123;&#123; printf `probe_http_status_code&#123;instance=&apos;%s&apos;&#125;` $labels.instance | query | first | value &#125;&#125; http检测失败，请检查！&quot;</span><br><span class="line">      summary: &quot;http检测&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>mysql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: MySQLStatsAlert</span><br><span class="line">  rules:</span><br><span class="line">    - alert: MySQL is down</span><br><span class="line">      expr: mysql_up == 0</span><br><span class="line">      for: 1m</span><br><span class="line">      labels:</span><br><span class="line">        severity: critical</span><br><span class="line">      annotations:</span><br><span class="line">        summary: &quot;Instance &#123;&#123; $labels.instance &#125;&#125; MySQL is down&quot;</span><br><span class="line">        description: &quot;MySQL database is down. This requires immediate action!&quot;</span><br><span class="line">    - alert: Mysql_High_QPS</span><br><span class="line">      expr: rate(mysql_global_status_questions[5m]) &gt; 500 </span><br><span class="line">      for: 2m</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">      annotations:</span><br><span class="line">        summary: &quot;&#123;&#123;$labels.instance&#125;&#125;: Mysql_High_QPS detected&quot;</span><br><span class="line">        description: &quot;&#123;&#123;$labels.instance&#125;&#125;: Mysql opreation is more than 500 per second ,(current value is: &#123;&#123; $value &#125;&#125;)&quot;  </span><br><span class="line">    - alert: Mysql_Too_Many_Connections</span><br><span class="line">      expr: rate(mysql_global_status_threads_connected[5m]) &gt; 200</span><br><span class="line">      for: 2m</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">      annotations:</span><br><span class="line">        summary: &quot;&#123;&#123;$labels.instance&#125;&#125;: Mysql Too Many Connections detected&quot;</span><br><span class="line">        description: &quot;&#123;&#123;$labels.instance&#125;&#125;: Mysql Connections is more than 100 per second ,(current value is: &#123;&#123; $value &#125;&#125;)&quot;  </span><br><span class="line">    - alert: Mysql_Too_Many_slow_queries</span><br><span class="line">      expr: rate(mysql_global_status_slow_queries[5m]) &gt; 3</span><br><span class="line">      for: 2m</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">      annotations:</span><br><span class="line">        summary: &quot;&#123;&#123;$labels.instance&#125;&#125;: Mysql_Too_Many_slow_queries detected&quot;</span><br><span class="line">        description: &quot;&#123;&#123;$labels.instance&#125;&#125;: Mysql slow_queries is more than 3 per second ,(current value is: &#123;&#123; $value &#125;&#125;)&quot;  </span><br><span class="line">    - alert: SQL thread stopped </span><br><span class="line">      expr: mysql_slave_status_slave_sql_running == 0</span><br><span class="line">      for: 1m</span><br><span class="line">      labels:</span><br><span class="line">        severity: critical</span><br><span class="line">      annotations:</span><br><span class="line">        summary: &quot;Instance &#123;&#123; $labels.instance &#125;&#125; SQL thread stopped&quot;</span><br><span class="line">        description: &quot;SQL thread has stopped. This is usually because it cannot apply a SQL statement received from the master.&quot;</span><br><span class="line">    - alert: Slave lagging behind Master</span><br><span class="line">      expr: rate(mysql_slave_status_seconds_behind_master[5m]) &gt;30 </span><br><span class="line">      for: 1m</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning </span><br><span class="line">      annotations:</span><br><span class="line">        summary: &quot;Instance &#123;&#123; $labels.instance &#125;&#125; Slave lagging behind Master&quot;</span><br><span class="line">        description: &quot;Slave is lagging behind Master. Please check if Slave threads are running and if there are some performance issues!&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Ali Cloud</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: slb</span><br><span class="line">  rules:</span><br><span class="line">  - alert: slb_5xx_percent:warning</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_slb_dashboard_StatusCode5xx) by (vip, port) /</span><br><span class="line">      sum(aliyun_acs_slb_dashboard_Qps) by (vip, port) &gt; 0.01</span><br><span class="line">    labels:</span><br><span class="line">      severity: 2</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;SLB &#123;&#123; $labels.vip &#125;&#125;:&#123;&#123; $labels.port &#125;&#125; 5xx percent &gt; 1%&apos;</span><br><span class="line">  - alert: slb_5xx_percent:high</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_slb_dashboard_StatusCode5xx) by (vip, port) /</span><br><span class="line">      sum(aliyun_acs_slb_dashboard_Qps) by (vip, port) &gt; 0.05</span><br><span class="line">    labels:</span><br><span class="line">      severity: 1</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;SLB &#123;&#123; $labels.vip &#125;&#125;:&#123;&#123; $labels.port &#125;&#125; 5xx percent &gt; 5%&apos;</span><br><span class="line">  - alert: slb_5xx_percent:critical</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_slb_dashboard_StatusCode5xx) by (vip, port) /</span><br><span class="line">      sum(aliyun_acs_slb_dashboard_Qps) by (vip, port) &gt; 0.1</span><br><span class="line">    labels:</span><br><span class="line">      severity: 0</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;SLB &#123;&#123; $labels.vip &#125;&#125;:&#123;&#123; $labels.port &#125;&#125; 5xx percent &gt; 10%&apos;</span><br><span class="line">  - alert: slb_response_time:high</span><br><span class="line">    expr: |-</span><br><span class="line">      avg(aliyun_acs_slb_dashboard_Rt) by (vip, port) &gt; 200</span><br><span class="line">    labels:</span><br><span class="line">      severity: 1</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;SLB &#123;&#123; $labels.vip &#125;&#125;:&#123;&#123; $labels.port &#125;&#125; RT &gt; 200ms&apos;</span><br><span class="line">  - alert: slb_response_time:critical</span><br><span class="line">    expr: |-</span><br><span class="line">      avg(aliyun_acs_slb_dashboard_Rt) by (vip, port) &gt; 500</span><br><span class="line">    labels:</span><br><span class="line">      severity: 0</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;SLB &#123;&#123; $labels.vip &#125;&#125;:&#123;&#123; $labels.port &#125;&#125; RT &gt; 500ms&apos;</span><br><span class="line">  - alert: slb_tx_traffic_drop_percent:critical</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_slb_dashboard_DropTrafficTX) by (vip, port) /</span><br><span class="line">      sum(aliyun_acs_slb_dashboard_TrafficTXNew) by (vip, port) &gt; 0.001</span><br><span class="line">    labels:</span><br><span class="line">      severity: 0</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;SLB &#123;&#123; $labels.vip &#125;&#125;:&#123;&#123; $labels.port &#125;&#125; tx traffic drop percent &gt; 0.1%&apos;</span><br><span class="line">  - alert: slb_rx_traffic_drop_percent:critical</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_slb_dashboard_DropTrafficRX) by (vip, port) /</span><br><span class="line">      sum(aliyun_acs_slb_dashboard_TrafficRXNew) by (vip, port) &gt; 0.001</span><br><span class="line">    labels:</span><br><span class="line">      severity: 0</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;SLB &#123;&#123; $labels.vip &#125;&#125;:&#123;&#123; $labels.port &#125;&#125; rx traffic drop percent &gt; 0.1%&apos;</span><br><span class="line"></span><br><span class="line">- name: ecs</span><br><span class="line">  rules:</span><br><span class="line">  - alert: ecs_cpu_pressure:warning</span><br><span class="line">    expr: |-</span><br><span class="line">      (aliyun_acs_ecs_dashboard_CPUUtilization &gt; 80)</span><br><span class="line">      * on (instanceId) group_left(VpcAttributes,HostName,InnerIpAddress)</span><br><span class="line">      label_replace(aliyun_meta_ecs_info,&quot;instanceId&quot;,&quot;$1&quot;,&quot;InstanceId&quot;,&quot;(.*)&quot;)</span><br><span class="line">    labels:</span><br><span class="line">      severity: 2</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;ECS &#123;&#123; $labels.HostName &#125;&#125; cpu usage &gt; 80%&apos;</span><br><span class="line">  - alert: ecs_cpu_pressure:high</span><br><span class="line">    expr: |-</span><br><span class="line">      (aliyun_acs_ecs_dashboard_CPUUtilization &gt; 95)</span><br><span class="line">      * on (instanceId) group_left(VpcAttributes,HostName,InnerIpAddress)</span><br><span class="line">      label_replace(aliyun_meta_ecs_info,&quot;instanceId&quot;,&quot;$1&quot;,&quot;InstanceId&quot;,&quot;(.*)&quot;)</span><br><span class="line">    labels:</span><br><span class="line">      severity: 1</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;ECS &#123;&#123; $labels.HostName &#125;&#125; cpu usage &gt; 95%&apos;</span><br><span class="line">  - alert: ecs_memory_pressure:warning</span><br><span class="line">    expr: |-</span><br><span class="line">      (aliyun_acs_ecs_dashboard_memory_usedutilization &gt; 80)</span><br><span class="line">      * on (instanceId) group_left(VpcAttributes,HostName,InnerIpAddress)</span><br><span class="line">      label_replace(aliyun_meta_ecs_info,&quot;instanceId&quot;,&quot;$1&quot;,&quot;InstanceId&quot;,&quot;(.*)&quot;)</span><br><span class="line">    labels:</span><br><span class="line">      severity: 2</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;ECS &#123;&#123; $labels.HostName &#125;&#125; memory usage &gt; 80%&apos;</span><br><span class="line">  - alert: ecs_memory_pressure:high</span><br><span class="line">    expr: |-</span><br><span class="line">      (aliyun_acs_ecs_dashboard_memory_usedutilization &gt; 95)</span><br><span class="line">      * on (instanceId) group_left(VpcAttributes,HostName,InnerIpAddress)</span><br><span class="line">      label_replace(aliyun_meta_ecs_info,&quot;instanceId&quot;,&quot;$1&quot;,&quot;InstanceId&quot;,&quot;(.*)&quot;)</span><br><span class="line">    labels:</span><br><span class="line">      severity: 1</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;ECS &#123;&#123; $labels.HostName &#125;&#125; memory usage &gt; 95%&apos;</span><br><span class="line">  - alert: ecs_load_avg:warning</span><br><span class="line">    expr: |-</span><br><span class="line">      (aliyun_acs_ecs_dashboard_load_5m &gt; 10)</span><br><span class="line">      * on (instanceId) group_left(VpcAttributes,HostName,InnerIpAddress)</span><br><span class="line">      label_replace(aliyun_meta_ecs_info,&quot;instanceId&quot;,&quot;$1&quot;,&quot;InstanceId&quot;,&quot;(.*)&quot;)</span><br><span class="line">    labels:</span><br><span class="line">      severity: 2</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;ECS &#123;&#123; $labels.HostName &#125;&#125; loadAvg5m &gt; 10&apos;</span><br><span class="line">  - alert: ecs_load_avg:high</span><br><span class="line">    expr: |-</span><br><span class="line">      (aliyun_acs_ecs_dashboard_load_5m &gt; 20)</span><br><span class="line">      * on (instanceId) group_left(VpcAttributes,HostName,InnerIpAddress)</span><br><span class="line">      label_replace(aliyun_meta_ecs_info,&quot;instanceId&quot;,&quot;$1&quot;,&quot;InstanceId&quot;,&quot;(.*)&quot;)</span><br><span class="line">    labels:</span><br><span class="line">      severity: 1</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;ECS &#123;&#123; $labels.HostName &#125;&#125; loadAvg5m &gt; 20&apos;</span><br><span class="line">  - alert: ecs_disk_pressure:high</span><br><span class="line">    expr: |-</span><br><span class="line">      (aliyun_acs_ecs_dashboard_diskusage_utilization &gt; 90)</span><br><span class="line">      * on (instanceId) group_left(VpcAttributes,HostName,InnerIpAddress)</span><br><span class="line">      label_replace(aliyun_meta_ecs_info,&quot;instanceId&quot;,&quot;$1&quot;,&quot;InstanceId&quot;,&quot;(.*)&quot;)</span><br><span class="line">    labels:</span><br><span class="line">      severity: 1</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;ECS &#123;&#123; $labels.HostName &#125;&#125; disk usage &gt; 80%&apos;</span><br><span class="line">  - alert: ecs_disk_pressure:critical</span><br><span class="line">    expr: |-</span><br><span class="line">      (aliyun_acs_ecs_dashboard_diskusage_utilization &gt; 95)</span><br><span class="line">      * on (instanceId) group_left(VpcAttributes,HostName,InnerIpAddress)</span><br><span class="line">      label_replace(aliyun_meta_ecs_info,&quot;instanceId&quot;,&quot;$1&quot;,&quot;InstanceId&quot;,&quot;(.*)&quot;)</span><br><span class="line">    labels:</span><br><span class="line">      severity: 0</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;ECS &#123;&#123; $labels.HostName &#125;&#125; disk usage &gt; 95%&apos;</span><br><span class="line">  - alert: ecs_too_many_connections:warning</span><br><span class="line">    expr: |-</span><br><span class="line">      (aliyun_acs_ecs_dashboard_tcpconnection&#123;state=&quot;TCP_TOTAL&quot;&#125; &gt; 1000)</span><br><span class="line">      * on (instanceId) group_left(VpcAttributes,HostName,InnerIpAddress)</span><br><span class="line">      label_replace(aliyun_meta_ecs_info,&quot;instanceId&quot;,&quot;$1&quot;,&quot;InstanceId&quot;,&quot;(.*)&quot;)</span><br><span class="line">    labels:</span><br><span class="line">      severity: 2</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;ECS &#123;&#123; $labels.HostName &#125;&#125; tcp_total &gt; 1000&apos;</span><br><span class="line">  - alert: ecs_too_many_connections:high</span><br><span class="line">    expr: |-</span><br><span class="line">      (aliyun_acs_ecs_dashboard_tcpconnection&#123;state=&quot;TCP_TOTAL&quot;&#125; &gt; 2000)</span><br><span class="line">      * on (instanceId) group_left(VpcAttributes,HostName,InnerIpAddress)</span><br><span class="line">      label_replace(aliyun_meta_ecs_info,&quot;instanceId&quot;,&quot;$1&quot;,&quot;InstanceId&quot;,&quot;(.*)&quot;)</span><br><span class="line">    labels:</span><br><span class="line">      severity: 1</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;ECS &#123;&#123; $labels.HostName &#125;&#125; tcp_total &gt; 2000&apos;</span><br><span class="line"></span><br><span class="line">- name: rds</span><br><span class="line">  rules:</span><br><span class="line">  - alert: rds_cpu_pressure:high</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_rds_dashboard_CpuUsage</span><br><span class="line">        * on (instanceId) group_left(DBInstanceDescription,ZoneId)</span><br><span class="line">        label_replace(aliyun_meta_rds_info, &quot;instanceId&quot;, &quot;$1&quot;, &quot;DBInstanceId&quot;, &quot;(.*)&quot;))</span><br><span class="line">      without (instance, userId, job) &gt; 85</span><br><span class="line">    labels:</span><br><span class="line">      severity: 1</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;RDS &#123;&#123; $labels.DBInstanceDescription &#125;&#125; under high cpu pressure &gt; 85%&apos;</span><br><span class="line">  - alert: rds_cpu_pressure:critical</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_rds_dashboard_CpuUsage</span><br><span class="line">        * on (instanceId) group_left(DBInstanceDescription,ZoneId)</span><br><span class="line">        label_replace(aliyun_meta_rds_info, &quot;instanceId&quot;, &quot;$1&quot;, &quot;DBInstanceId&quot;, &quot;(.*)&quot;))</span><br><span class="line">      without (instance, userId, job) &gt; 95</span><br><span class="line">    labels:</span><br><span class="line">      severity: 0</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;RDS &#123;&#123; $labels.DBInstanceDescription &#125;&#125; under critical cpu pressure &gt; 95%&apos;</span><br><span class="line">  - alert: rds_memory_pressure:high</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_rds_dashboard_MemoryUsage</span><br><span class="line">        * on (instanceId) group_left(DBInstanceDescription,ZoneId)</span><br><span class="line">        label_replace(aliyun_meta_rds_info, &quot;instanceId&quot;, &quot;$1&quot;, &quot;DBInstanceId&quot;, &quot;(.*)&quot;))</span><br><span class="line">      without (instance, userId, job) &gt; 85</span><br><span class="line">    labels:</span><br><span class="line">      severity: 1</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;RDS &#123;&#123; $labels.DBInstanceDescription &#125;&#125; under high memory pressure &gt; 85%&apos;</span><br><span class="line">  - alert: rds_memory_pressure:critical</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_rds_dashboard_MemoryUsage</span><br><span class="line">        * on (instanceId) group_left(DBInstanceDescription,ZoneId)</span><br><span class="line">        label_replace(aliyun_meta_rds_info, &quot;instanceId&quot;, &quot;$1&quot;, &quot;DBInstanceId&quot;, &quot;(.*)&quot;))</span><br><span class="line">      without (instance, userId, job) &gt; 95</span><br><span class="line">    labels:</span><br><span class="line">      severity: 0</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;RDS &#123;&#123; $labels.DBInstanceDescription &#125;&#125; under critical memory pressure &gt; 95%&apos;</span><br><span class="line">  - alert: rds_iops_pressure:high</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_rds_dashboard_IOPSUsage</span><br><span class="line">        * on (instanceId) group_left(DBInstanceDescription,ZoneId)</span><br><span class="line">        label_replace(aliyun_meta_rds_info, &quot;instanceId&quot;, &quot;$1&quot;, &quot;DBInstanceId&quot;, &quot;(.*)&quot;))</span><br><span class="line">      without (instance, userId, job) &gt; 80</span><br><span class="line">    labels:</span><br><span class="line">      severity: 1</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;RDS &#123;&#123; $labels.DBInstanceDescription &#125;&#125; under high iops pressure &gt; 80%&apos;</span><br><span class="line">  - alert: rds_iops_pressure:critical</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_rds_dashboard_IOPSUsage</span><br><span class="line">        * on (instanceId) group_left(DBInstanceDescription,ZoneId)</span><br><span class="line">        label_replace(aliyun_meta_rds_info, &quot;instanceId&quot;, &quot;$1&quot;, &quot;DBInstanceId&quot;, &quot;(.*)&quot;))</span><br><span class="line">      without (instance, userId, job) &gt; 90</span><br><span class="line">    labels:</span><br><span class="line">      severity: 0</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;RDS &#123;&#123; $labels.DBInstanceDescription &#125;&#125; under high iops pressure &gt; 90%&apos;</span><br><span class="line">  - alert: rds_disk_space_exhausted:warning</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_rds_dashboard_DiskUsage</span><br><span class="line">        * on (instanceId) group_left(DBInstanceDescription,ZoneId)</span><br><span class="line">        label_replace(aliyun_meta_rds_info, &quot;instanceId&quot;, &quot;$1&quot;, &quot;DBInstanceId&quot;, &quot;(.*)&quot;))</span><br><span class="line">      without (instance, userId, job) &gt; 85</span><br><span class="line">    labels:</span><br><span class="line">      severity: 2</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;RDS &#123;&#123; $labels.DBInstanceDescription &#125;&#125; disk space under pressure &gt; 85%&apos;</span><br><span class="line">  - alert: rds_disk_space_exhausted:critical</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_rds_dashboard_DiskUsage</span><br><span class="line">        * on (instanceId) group_left(DBInstanceDescription,ZoneId)</span><br><span class="line">        label_replace(aliyun_meta_rds_info, &quot;instanceId&quot;, &quot;$1&quot;, &quot;DBInstanceId&quot;, &quot;(.*)&quot;))</span><br><span class="line">      without (instance, userId, job) &gt; 95</span><br><span class="line">    labels:</span><br><span class="line">      severity: 0</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;RDS &#123;&#123; $labels.DBInstanceDescription &#125;&#125; disk space will be exhausted soon &gt; 95%&apos;</span><br><span class="line">  - alert: rds_connection_pressure:high</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_rds_dashboard_ConnectionUsage</span><br><span class="line">        * on (instanceId) group_left(DBInstanceDescription,ZoneId)</span><br><span class="line">        label_replace(aliyun_meta_rds_info, &quot;instanceId&quot;, &quot;$1&quot;, &quot;DBInstanceId&quot;, &quot;(.*)&quot;))</span><br><span class="line">      without (instance, userId, job) &gt; 85</span><br><span class="line">    labels:</span><br><span class="line">      severity: 1</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;RDS &#123;&#123; $labels.DBInstanceDescription &#125;&#125; connection usage &gt; 85%&apos;</span><br><span class="line">  - alert: rds_connection_pressure:critical</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_rds_dashboard_ConnectionUsage</span><br><span class="line">        * on (instanceId) group_left(DBInstanceDescription,ZoneId)</span><br><span class="line">        label_replace(aliyun_meta_rds_info, &quot;instanceId&quot;, &quot;$1&quot;, &quot;DBInstanceId&quot;, &quot;(.*)&quot;))</span><br><span class="line">      without (instance, userId, job) &gt; 95</span><br><span class="line">    labels:</span><br><span class="line">      severity: 1</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;RDS &#123;&#123; $labels.DBInstanceDescription &#125;&#125; connection usage &gt; 95%&apos;</span><br><span class="line"></span><br><span class="line">- name: redis</span><br><span class="line">  rules:</span><br><span class="line">  - alert: redis_cpu_pressure:high</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_kvstore_CpuUsage</span><br><span class="line">          * on (instanceId) group_left(PrivateIp,InstanceName)</span><br><span class="line">          label_replace(aliyun_meta_redis_info, &quot;instanceId&quot;, &quot;$1&quot;, &quot;UserName&quot;, &quot;(.*)&quot;))</span><br><span class="line">      without (instance, userId, job) &gt; 85</span><br><span class="line">    labels:</span><br><span class="line">      severity: 1</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;Redis &#123;&#123; $labels.InstanceName &#125;&#125; under high cpu pressure &gt; 85%&apos;</span><br><span class="line">  - alert: redis_cpu_pressure:critical</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_kvstore_CpuUsage</span><br><span class="line">          * on (instanceId) group_left(PrivateIp,InstanceName)</span><br><span class="line">          label_replace(aliyun_meta_redis_info, &quot;instanceId&quot;, &quot;$1&quot;, &quot;UserName&quot;, &quot;(.*)&quot;))</span><br><span class="line">      without (instance, userId, job) &gt; 95</span><br><span class="line">    labels:</span><br><span class="line">      severity: 0</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;Redis &#123;&#123; $labels.InstanceName &#125;&#125; under high cpu pressure &gt; 95%&apos;</span><br><span class="line">  - alert: redis_memory_pressure:high</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_kvstore_MemoryUsage</span><br><span class="line">          * on (instanceId) group_left(PrivateIp,InstanceName)</span><br><span class="line">          label_replace(aliyun_meta_redis_info, &quot;instanceId&quot;, &quot;$1&quot;, &quot;UserName&quot;, &quot;(.*)&quot;))</span><br><span class="line">      without (instance, userId, job) &gt; 85</span><br><span class="line">    labels:</span><br><span class="line">      severity: 1</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;Redis &#123;&#123; $labels.InstanceName &#125;&#125; memory usage &gt; 85%&apos;</span><br><span class="line">  - alert: redis_memory_pressure:critical</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_kvstore_MemoryUsage</span><br><span class="line">          * on (instanceId) group_left(PrivateIp,InstanceName)</span><br><span class="line">          label_replace(aliyun_meta_redis_info, &quot;instanceId&quot;, &quot;$1&quot;, &quot;UserName&quot;, &quot;(.*)&quot;))</span><br><span class="line">      without (instance, userId, job) &gt; 95</span><br><span class="line">    labels:</span><br><span class="line">      severity: 0</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;Redis &#123;&#123; $labels.InstanceName &#125;&#125; memory usage &gt; 95%&apos;</span><br><span class="line">  - alert: redis_connection_pressure:high</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_kvstore_ConnectionUsage</span><br><span class="line">          * on (instanceId) group_left(PrivateIp,InstanceName)</span><br><span class="line">          label_replace(aliyun_meta_redis_info, &quot;instanceId&quot;, &quot;$1&quot;, &quot;UserName&quot;, &quot;(.*)&quot;))</span><br><span class="line">      without (instance, userId, job) &gt; 85</span><br><span class="line">    labels:</span><br><span class="line">      severity: 1</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;Redis &#123;&#123; $labels.InstanceName &#125;&#125; connection usage &gt; 85%&apos;</span><br><span class="line">  - alert: redis_connection_pressure:critical</span><br><span class="line">    expr: |-</span><br><span class="line">      sum(aliyun_acs_kvstore_ConnectionUsage</span><br><span class="line">          * on (instanceId) group_left(PrivateIp,InstanceName)</span><br><span class="line">          label_replace(aliyun_meta_redis_info, &quot;instanceId&quot;, &quot;$1&quot;, &quot;UserName&quot;, &quot;(.*)&quot;))</span><br><span class="line">      without (instance, userId, job) &gt; 95</span><br><span class="line">    labels:</span><br><span class="line">      severity: 0</span><br><span class="line">    for: 5m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &apos;Redis &#123;&#123; $labels.InstanceName &#125;&#125; connection usage &gt; 95%&apos;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="Check-Rules-File"><a href="#Check-Rules-File" class="headerlink" title="Check Rules File"></a><b>Check Rules File</b></h5><p>Prometheus includes a useful utility that you can use to check whether the rules you’ve written are OK. You can use it like this:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">promtool check config /etc/prometheus/prometheus.yml</span><br></pre></td></tr></table></figure></p>
<p>ref<br><a href="https://www.cnblogs.com/wayne-liu/p/9273452.html" target="_blank" rel="noopener">Prometheus 操作符</a><br><a href="https://www.kancloud.cn/cdh0805010118/prometheus/719379" target="_blank" rel="noopener">prometheus</a><br><a href="https://www.robustperception.io/combining-alert-conditions" target="_blank" rel="noopener">Combining alert conditions</a><br><a href="http://keleir.me/2018/01/27/prometheus-in-practice/" target="_blank" rel="noopener">Prometheus in Practice</a><br><a href="https://medium.com/@tom.fawcett/time-of-day-based-notifications-with-prometheus-and-alertmanager-1bf7a23b7695" target="_blank" rel="noopener">Time of day based notifications with Prometheus and Alertmanager</a><br><a href="https://github.com/aylei/aliyun-exporter" target="_blank" rel="noopener">aliyun-exporter</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;First thing you should know is that there are two types of rules in Prometheus:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Recoding rules&lt;/li&gt;
&lt;li&gt;Alerting rules&lt;/li&gt;

    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>how to set-up-private-yum-repo</title>
    <link href="https://t1ger.github.io/2019/06/05/how-to-set-up-private-yum-repo/"/>
    <id>https://t1ger.github.io/2019/06/05/how-to-set-up-private-yum-repo/</id>
    <published>2019-06-05T05:56:19.000Z</published>
    <updated>2019-06-11T09:39:26.035Z</updated>
    
    <content type="html"><![CDATA[<h5 id="install-soft"><a href="#install-soft" class="headerlink" title="install soft"></a><b>install soft</b></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install createrepo</span><br><span class="line">yum install nginx</span><br></pre></td></tr></table></figure>
<h5 id="configure-repo"><a href="#configure-repo" class="headerlink" title="configure repo"></a><b>configure repo</b></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/yum/centos/7/os/x86_64</span><br><span class="line">htpasswd -c pass.db username</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        listen       [::]:80 default_server;</span><br><span class="line">        server_name  _;</span><br><span class="line">        root         /opt/yum;</span><br><span class="line">        auth_basic &quot;User Authentication&quot;;</span><br><span class="line">    	auth_basic_user_file pass.db;</span><br><span class="line">        location / &#123;</span><br><span class="line">               autoindex on;</span><br><span class="line">               autoindex_exact_size off;</span><br><span class="line">               autoindex_localtime on;</span><br><span class="line">               index index.html;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="download-package"><a href="#download-package" class="headerlink" title="download package "></a><b>download package </b></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install --downloadonly --downloaddir=/opt/yum/centos/7/os/x86_64/ packagename</span><br></pre></td></tr></table></figure>
<h5 id="generate-repo-file-and-create-yum-source"><a href="#generate-repo-file-and-create-yum-source" class="headerlink" title="generate repo file and create yum source"></a><b>generate repo file and create yum source</b></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[name]</span><br><span class="line">name=Apache Software</span><br><span class="line">baseurl=http://username:password@domain/centos/$releasever/os/$basearch/</span><br><span class="line">gpgkey=http://domain/centos/$releasever/os/$basearch/RPM-GPG-KEY-CentOS-7</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">autorefresh=0</span><br><span class="line"></span><br><span class="line">gpg --gen-key</span><br><span class="line">gpg --list-keys</span><br><span class="line">gpg --list-secret-keys</span><br><span class="line">gpg -a --export wssoft &gt;RPM-GPG-KEY-CentOS-7</span><br><span class="line">#import the key into the RPM database</span><br><span class="line">rpm --import RPM-GPG-KEY-CentOS-7 </span><br><span class="line">#[optional] confirm the key was successfully imported</span><br><span class="line">rpm -q gpg-pubkey --qf &apos;%&#123;NAME&#125;-%&#123;VERSION&#125;-%&#123;RELEASE&#125;\t%&#123;SUMMARY&#125;\n&apos; </span><br><span class="line">#Add the GPG signing details to your rpm environment</span><br><span class="line">echo &quot;%_signature gpg&quot; &gt; ~/.rpmmacros</span><br><span class="line">echo &quot;%_gpg_name gpguser&quot; &gt;&gt; ~/.rpmmacros</span><br><span class="line">#Now the user gpguser is configured to sign RPMs with the GPG key</span><br><span class="line">cd /opt/yum/centos/7/os/x86_64</span><br><span class="line">rpm --resign *.rpm</span><br><span class="line"></span><br><span class="line">#You can confirm that with randomly querying the packages or do a block query to return the singature line for each:</span><br><span class="line">rpm -qpi *.rpm | awk &apos;/Signature/&apos;</span><br><span class="line"></span><br><span class="line">gpg --detach-sign --armor repodata/repomd.xml </span><br><span class="line"></span><br><span class="line">createrepo /opt/yum/centos/7/os/x86_64/</span><br></pre></td></tr></table></figure>
<h5 id="client"><a href="#client" class="headerlink" title="client"></a><b>client</b></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/name.repo http://user:password@domain/centos/7/os/x86_64/name.repo</span><br></pre></td></tr></table></figure>
<p>ref<br><a href="https://blog.csdn.net/u014636209/article/details/82453359" target="_blank" rel="noopener">GPG 公私钥生成</a><br><a href="https://blog.packagecloud.io/eng/2014/11/24/howto-gpg-sign-verify-rpm-packages-yum-repositories/" target="_blank" rel="noopener">HOWTO: GPG sign and verify RPM packages and yum repositories</a><br><a href="http://linuxsysconfig.com/2013/04/create-a-yum-repository-with-custom-gpg-signed-packages/" target="_blank" rel="noopener">Create a yum repository with custom GPG-signed RPM packages</a></p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;h5 id=&quot;install-soft&quot;&gt;&lt;a href=&quot;#install-soft&quot; class=&quot;headerlink&quot; title=&quot;install soft&quot;&gt;&lt;/a&gt;&lt;b&gt;install soft&lt;/b&gt;&lt;/h5&gt;&lt;figure class=&quot;highlight p
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Backup Mysql by [ZRM] for MySQL</title>
    <link href="https://t1ger.github.io/2019/05/10/Backup-Mysql-by-ZRM-for-MySQL/"/>
    <id>https://t1ger.github.io/2019/05/10/Backup-Mysql-by-ZRM-for-MySQL/</id>
    <published>2019-05-10T03:17:23.000Z</published>
    <updated>2019-05-10T03:31:06.122Z</updated>
    
    <content type="html"><![CDATA[<h5 id="install-zrm-backup"><a href="#install-zrm-backup" class="headerlink" title="install zrm backup"></a><b>install zrm backup</b></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release -y</span><br><span class="line">yum install MySQL-zrm.noarch -y</span><br></pre></td></tr></table></figure>
<h5 id="create-mysql-user-account-privileges"><a href="#create-mysql-user-account-privileges" class="headerlink" title="create mysql user account privileges"></a><b>create mysql user account privileges</b></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grant select, insert, update, create, drop, reload, shutdown, alter, super, lock tables, replication client on *.* to &apos;backupuser@&apos;%&apos; identified by &apos;secret password&apos;;</span><br></pre></td></tr></table></figure>
<h5 id="config-zrm-backup"><a href="#config-zrm-backup" class="headerlink" title="config zrm backup"></a><b>config zrm backup</b></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/mysql-zrm/</span><br><span class="line">mkdir dailyrun</span><br><span class="line">cp mysql-zrm.conf dailyrun</span><br><span class="line">cd dailyrun</span><br><span class="line">cat mysql-zrm.conf</span><br><span class="line"></span><br><span class="line">backup-mode=logical</span><br><span class="line">destination=/var/lib/mysql-zrm  //backup directory, make sure disk large enough</span><br><span class="line">retention-policy=180D</span><br><span class="line">compress=1</span><br><span class="line">compress-plugin=/usr/bin/gzip</span><br><span class="line">databases=wikidb forums</span><br><span class="line">user=&quot;backupuser&quot;</span><br><span class="line">password=&quot;password&quot;</span><br><span class="line">host=&quot;192.168.10.1&quot;</span><br><span class="line">port=3306</span><br><span class="line">default-character-set=utf8</span><br><span class="line">mysql-binpath=&quot;/usr/local/mysql/bin&quot;</span><br><span class="line">mailto=&quot;user@company.com.cn&quot;   // make user postfix service start </span><br><span class="line">mail-policy=only-on-error</span><br></pre></td></tr></table></figure>
<h5 id="Perform-a-Backup"><a href="#Perform-a-Backup" class="headerlink" title="Perform a Backup"></a><b>Perform a Backup</b></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#backup now Verification of Backup Images</span><br><span class="line">mysql-zrm --action verify-backup --backup-set dailyrun</span><br><span class="line">mysql-zrm-scheduler --now --backup-set dailyrun     </span><br><span class="line"></span><br><span class="line">#add backup task to schedule, for example, backup database every day 1am</span><br><span class="line">mysql-zrm-scheduler --add --interval daily --start 01:00 --backup-level 0 --backup-set dailyrun</span><br><span class="line"></span><br><span class="line">#query backup schedule info</span><br><span class="line">mysql-zrm-scheduler --query</span><br></pre></td></tr></table></figure>
<h5 id="Backup-Reports"><a href="#Backup-Reports" class="headerlink" title="Backup Reports"></a><b>Backup Reports</b></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql-zrm-reporter --where backup-set=dailyrun --show backup-status-info</span><br><span class="line">mysql-zrm-reporter --where backup-set=dailyrun --show backup-performance-info</span><br><span class="line"># Verification of Backup Images</span><br><span class="line">mysql-zrm --action verify-backup --backup-set dailyrun</span><br></pre></td></tr></table></figure>
<h5 id="Perform-a-full-restoration"><a href="#Perform-a-full-restoration" class="headerlink" title="Perform a full restoration"></a><b>Perform a full restoration</b></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#example for restore database</span><br><span class="line">[root@localhost dailyrun]# mysql-zrm-reporter --show restore-info --where backup-set=dailyrun</span><br><span class="line"></span><br><span class="line">REPORT TYPE : restore-info </span><br><span class="line"></span><br><span class="line">          backup_set  backup_date                  backup_level  backup_directory                          backup_status         comment</span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">            dailyrun  Fri 10 May 2019 09:48:58                0  /var/lib/mysql-zrm/dailyrun/201905100948  Backup succeeded      ----</span><br><span class="line">                      AM CST                                     58</span><br><span class="line"></span><br><span class="line">[root@localhost dailyrun]# mysql-zrm --action restore --backup-set dailyrun --source-directory /var/lib/mysql-zrm/dailyrun/20190510094858/</span><br><span class="line">restore:INFO: ZRM for MySQL Community Edition - version 3.0</span><br><span class="line">dailyrun:restore:INFO: The quick backup-type is supported only for snapshot backups. Setting backup-type to &apos;regular&apos;</span><br><span class="line">dailyrun:restore:WARNING: Binary logging is off.</span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">dailyrun:restore:INFO: Restored database(s) from logical backup:  wikidb forums</span><br><span class="line">dailyrun:restore:INFO: Restore done in 3 seconds.</span><br></pre></td></tr></table></figure>
<p>ref<br><a href="https://github.com/tuhoanganh/mysql-zrm" target="_blank" rel="noopener">mysql-zrm</a><br><a href="https://www.zmanda.com/quick-mysql-backup.html" target="_blank" rel="noopener">[ZRM] for MySQL</a><br><a href="https://www.linux-geex.com/mysql-zrm-backuppc-centos-7/" target="_blank" rel="noopener">MySQL-ZRM and BackupPC – CentOS 7</a></p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;h5 id=&quot;install-zrm-backup&quot;&gt;&lt;a href=&quot;#install-zrm-backup&quot; class=&quot;headerlink&quot; title=&quot;install zrm backup&quot;&gt;&lt;/a&gt;&lt;b&gt;install zrm backup&lt;/b&gt;&lt;/h5&gt;&lt;f
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Shell命令行处理JSON</title>
    <link href="https://t1ger.github.io/2019/05/09/Shell%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%A4%84%E7%90%86JSON/"/>
    <id>https://t1ger.github.io/2019/05/09/Shell命令行处理JSON/</id>
    <published>2019-05-09T05:43:09.000Z</published>
    <updated>2019-05-09T06:25:41.295Z</updated>
    
    <content type="html"><![CDATA[<h5 id="安装JQ"><a href="#安装JQ" class="headerlink" title="安装JQ"></a><b>安装JQ</b></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -O /usr/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64</span><br><span class="line">chmod +x /usr/bin/jq</span><br></pre></td></tr></table></figure>
<h5 id="常用举例"><a href="#常用举例" class="headerlink" title="常用举例"></a><b>常用举例</b></h5><ul>
<li><p>原始JSON数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;Rd&quot;:&quot;android&quot;,&quot;Ru&quot;:&quot;orginfo&quot;,&quot;service_type&quot;:&quot;&quot;,&quot;level&quot;:&quot;info&quot;,&quot;Rs&quot;:&quot;xzn&quot;,&quot;R&quot;:&quot;MsgInfo&quot;,&quot;runtime&quot;:45,&quot;date&quot;:&quot;2019-05-08 23:59:58&quot;,&quot;Rversion&quot;:&quot;6.7&quot;,&quot;clientip&quot;:&quot;140.97.127.275&quot;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>格式化输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tmp]# jq -r . abc.json </span><br><span class="line">&#123;</span><br><span class="line">  &quot;Rd&quot;: &quot;android&quot;,</span><br><span class="line">  &quot;Ru&quot;: &quot;orginfo&quot;,</span><br><span class="line">  &quot;service_type&quot;: &quot;&quot;,</span><br><span class="line">  &quot;level&quot;: &quot;info&quot;,</span><br><span class="line">  &quot;Rs&quot;: &quot;xzn&quot;,</span><br><span class="line">  &quot;R&quot;: &quot;MsgInfo&quot;,</span><br><span class="line">  &quot;runtime&quot;: 45,</span><br><span class="line">  &quot;date&quot;: &quot;2019-05-08 23:59:58&quot;,</span><br><span class="line">  &quot;Rversion&quot;: &quot;6.7&quot;,</span><br><span class="line">  &quot;clientip&quot;: &quot;140.97.127.275&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>提取json指定字段转csv</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tmp]# jq -r &apos;[.runtime,(.clientip|tostring),(.Rs|tostring),(.R|tostring)]|join(&quot;,&quot;)&apos; abc.json       </span><br><span class="line">45,140.97.127.275,xzn,MsgInfo</span><br></pre></td></tr></table></figure>
</li>
<li><p>复杂json数据查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">complexJson=&apos;&#123;&quot;uid&quot;:&quot;u2013&quot;,&quot;nameInfo&quot;:[&#123;&quot;firstName&quot;:&quot;java&quot;,&quot;lastName&quot;:&quot;scala&quot;&#125;]&#125;&apos;</span><br><span class="line">echo $&#123;complexJson&#125; |jq</span><br><span class="line">&#123;</span><br><span class="line">  &quot;uid&quot;: &quot;u2013&quot;,</span><br><span class="line">  &quot;nameInfo&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;firstName&quot;: &quot;java&quot;,</span><br><span class="line">      &quot;lastName&quot;: &quot;scala&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">echo $&#123;complexJson&#125; |jq -r &apos;.nameInfo[].lastName&apos;</span><br><span class="line">结果:scala</span><br><span class="line">注意:.nameInfo[].lastName是获取.nameInfo[] json array中每个json object的lastName字段。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ cat sample.json</span><br><span class="line">[</span><br><span class="line">&#123;</span><br><span class="line">&quot;24hvol&quot;: &quot;3.908&quot;,</span><br><span class="line">&quot;code&quot;: &quot;AUR&quot;</span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">$ cat sample.json |jq -r &apos;.[][&quot;24hvol&quot;]&apos;</span><br><span class="line">3.908</span><br></pre></td></tr></table></figure>
</li>
<li><p>csv文件转json文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat csvData.csv</span><br><span class="line">1478,john,38</span><br><span class="line">1529,lucy,25</span><br><span class="line">1673,iris,22</span><br><span class="line">jq -R -c &apos;split(&quot;,&quot;)|&#123;&quot;uid&quot;:.[0],&quot;name&quot;:.[1],&quot;age&quot;:.[2]|tonumber&#125;&apos; csvData.csv &gt; csv2json.json</span><br><span class="line">cat csv2json.json</span><br><span class="line">&#123;&quot;uid&quot;:&quot;1478&quot;,&quot;name&quot;:&quot;john&quot;,&quot;age&quot;:38&#125;</span><br><span class="line">&#123;&quot;uid&quot;:&quot;1529&quot;,&quot;name&quot;:&quot;lucy&quot;,&quot;age&quot;:25&#125;</span><br><span class="line">&#123;&quot;uid&quot;:&quot;1673&quot;,&quot;name&quot;:&quot;iris&quot;,&quot;age&quot;:22&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<p>ref<br><a href="https://stedolan.github.io/jq/manual/#Basicfilters" target="_blank" rel="noopener">JQ使用手册</a><br><a href="https://github.com/stedolan/jq/issues/344" target="_blank" rel="noopener">Error with fields starting with a number</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h5 id=&quot;安装JQ&quot;&gt;&lt;a href=&quot;#安装JQ&quot; class=&quot;headerlink&quot; title=&quot;安装JQ&quot;&gt;&lt;/a&gt;&lt;b&gt;安装JQ&lt;/b&gt;&lt;/h5&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutt
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>How to align partitions for best performance using parted</title>
    <link href="https://t1ger.github.io/2019/04/18/How-to-align-partitions-for-best-performance-using-parted/"/>
    <id>https://t1ger.github.io/2019/04/18/How-to-align-partitions-for-best-performance-using-parted/</id>
    <published>2019-04-18T10:26:10.000Z</published>
    <updated>2019-04-18T10:54:16.730Z</updated>
    
    <content type="html"><![CDATA[<h5 id="backgroud"><a href="#backgroud" class="headerlink" title="backgroud"></a><b>backgroud</b></h5><p>as usual, Trying to create a 10TB partition using parted,I type command like<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">parted -s -a optimal /dev/sdb mklabel gpt -- mkpart primary xfs 1 -1</span><br></pre></td></tr></table></figure></p>
<p>but parted always complains as follows<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The resulting partition is not properly aligned for best performance</span><br></pre></td></tr></table></figure></p>
<h5 id="soulation"><a href="#soulation" class="headerlink" title="soulation"></a><b>soulation</b></h5><p>Add optimal_io_size to alignment_offset and divide the result by physical_block_size. In my case this was<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># cat /sys/block/sdb/queue/optimal_io_size</span><br><span class="line">1048576</span><br><span class="line"># cat /sys/block/sdb/alignment_offset</span><br><span class="line">0</span><br><span class="line">(1048576 + 0) / 512 = 2048</span><br><span class="line"></span><br><span class="line">#Your new parted command should look like</span><br><span class="line">parted -s -a optimal /dev/sdb mklabel gpt -- mkpart primary xfs 4608s 100%</span><br></pre></td></tr></table></figure></p>
<p>The trailing ‘s’ is important: it tells parted that you’re talking about sectors, not bytes or megabytes</p>
<p>finally,let check it,the partition will have been created with no warnings. You can check the alignment thusly (replacing ‘1’ with the partition number if necessary):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(parted) align-check optimal 1                                            </span><br><span class="line">1 aligned</span><br></pre></td></tr></table></figure></p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;h5 id=&quot;backgroud&quot;&gt;&lt;a href=&quot;#backgroud&quot; class=&quot;headerlink&quot; title=&quot;backgroud&quot;&gt;&lt;/a&gt;&lt;b&gt;backgroud&lt;/b&gt;&lt;/h5&gt;&lt;p&gt;as usual, Trying to create a 10TB p
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>how to use hexo deploy blog by  private gitlab</title>
    <link href="https://t1ger.github.io/2018/12/27/how-to-use-hexo-deploy-blog-by-private-gitlab/"/>
    <id>https://t1ger.github.io/2018/12/27/how-to-use-hexo-deploy-blog-by-private-gitlab/</id>
    <published>2018-12-27T07:52:17.000Z</published>
    <updated>2018-12-27T08:24:50.000Z</updated>
    
    <content type="html"><![CDATA[<p>环境：<br>gitlab访问地址： gitlab.io.com.cn<br>博客访问地址: tiger.pages.io.com.cn</p>
<p>1.开启GitLab Pages功能<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">##! Define to enable GitLab Pages</span><br><span class="line">pages_external_url &quot;pages.io.com.cn&quot;</span><br><span class="line">gitlab_pages[&apos;enable&apos;] = true</span><br></pre></td></tr></table></figure></p>
<p>2.安装配置GitLab Runner,可以点击<a href="https://packages.gitlab.com/runner/gitlab-runner" target="_blank" rel="noopener">这里</a> ，进行安装<br>通过 gitlab-runner register 命令进行注册，按照提示完成</p>
<p>3.配置nginx，这里nginx没有使用gitlab内置nginx<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen         80;</span><br><span class="line">        server_name   *.pages.io.com.cn;</span><br><span class="line">        error_log  logs/pages_error.log;</span><br><span class="line">        access_log logs/pages_access.log main;</span><br><span class="line"></span><br><span class="line">        charset utf-8;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">        error_page  404              /404.html;</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line"></span><br><span class="line">        root  /usr/local/gitlab/$http_host/public;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.提交blog代码</p>
<ul>
<li>登录gitlab.io.com.cn,在gitlab新建项目blog，这里为tiger.pages.io.com.cn<br>注意：项目名必须为访问域名，否则无法访问</li>
<li><p>本地新建hexo项目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cd test  #存放项目的目录</span><br><span class="line">$ hexo init blog  #下载模版项目</span><br><span class="line">$ cd blog  #打开模板项目目录</span><br><span class="line">$ cnpm install  #下载相关依赖的包</span><br><span class="line">$ cnpm install hexo-deployer-git --save  #安装扩展包</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果一切正常的话，就可以发布到gitlab pages上</p>
</li>
<li><p>添加ssh-key</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name &quot;tiger&quot;</span><br><span class="line">git config --global user.email &quot;tiger@gitlab.io.com.cn&quot;</span><br><span class="line">ssh-keygen -t rsa -C &quot;work@tiger.pub&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加.gitlab-ci.yml 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">variables:</span><br><span class="line">  WebPath: &quot;/usr/local/gitlab&quot;</span><br><span class="line"></span><br><span class="line">stages:</span><br><span class="line">  - install</span><br><span class="line">  - build</span><br><span class="line">  - deploy</span><br><span class="line"></span><br><span class="line">cache:</span><br><span class="line">  paths:</span><br><span class="line">    - node_modules/</span><br><span class="line">    </span><br><span class="line">install_npm:</span><br><span class="line">  stage: install</span><br><span class="line">  script:</span><br><span class="line">    - npm install</span><br><span class="line">  only:</span><br><span class="line">    - master</span><br><span class="line"></span><br><span class="line">build_public:</span><br><span class="line">  stage: build</span><br><span class="line">  script:</span><br><span class="line">    - hexo g</span><br><span class="line">  only: </span><br><span class="line">    - master</span><br><span class="line"></span><br><span class="line">deploy:</span><br><span class="line">  stage: deploy</span><br><span class="line">  script:</span><br><span class="line">    - hexo d</span><br><span class="line">    - rsync -avz --delete public $WebPath/$CI_PROJECT_NAME</span><br><span class="line">  artifacts:</span><br><span class="line">    paths:</span><br><span class="line">    - public  </span><br><span class="line">  only:</span><br><span class="line">    - master</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改站点配置文件&amp;更换主题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line">git remote add origin git@gitlab.io.com.cn/tiger/tiger.pages.io.com.cn.git</span><br><span class="line">git add .</span><br><span class="line">git commit -m &quot;init blog&quot;</span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>完成之后可以通过<a href="http://tiger.pages.io.com.cn" target="_blank" rel="noopener">http://tiger.pages.io.com.cn</a> 来浏览页面了</p>
<p>ref<br><a href="https://gitlab.com/gitlab-org/gitlab-ce/issues/33240" target="_blank" rel="noopener">Use gitlab pages under the same domain as gitlab</a><br><a href="https://wangxiaokai.vip/posts/2018-05-24-gitlab-ci-publish-hexo/" target="_blank" rel="noopener">个人站点升级持续集成，自动构建和部署</a><br><a href="http://www.daxiblog.com/2018/05/17/%E6%9C%AC%E5%9C%B0%E6%90%AD%E5%BB%BA%E7%9A%84gitlab%E4%B8%AD%E5%BC%80%E5%90%AFpages%E5%8A%9F%E8%83%BD%EF%BC%8C%E4%B8%8D%E9%9C%80%E8%A6%81%E5%9F%9F%E5%90%8D%E4%B9%9F%E5%8F%AF%E4%BB%A5/" target="_blank" rel="noopener">本地搭建的GitLab中开启Pages功能，不需要域名也可以</a></p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;环境：&lt;br&gt;gitlab访问地址： gitlab.io.com.cn&lt;br&gt;博客访问地址: tiger.pages.io.com.cn&lt;/p&gt;
&lt;p&gt;1.开启GitLab Pages功能&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>CentOS6 install Supervisor3</title>
    <link href="https://t1ger.github.io/2018/12/12/CentOS6-install-Supervisor3/"/>
    <id>https://t1ger.github.io/2018/12/12/CentOS6-install-Supervisor3/</id>
    <published>2018-12-12T10:06:52.000Z</published>
    <updated>2018-12-12T10:28:32.000Z</updated>
    
    <content type="html"><![CDATA[<ol>
<li><p>install python-pip</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if exit epel, already install, first remove supervisor</span><br><span class="line">yum remove supervisor</span><br><span class="line"></span><br><span class="line">yum -y install python-pip</span><br></pre></td></tr></table></figure>
</li>
<li><p>install supervisor</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pip install supervisor</span><br><span class="line"></span><br><span class="line"># supervisord -v</span><br><span class="line">3.3.4</span><br><span class="line"></span><br><span class="line">pip install meld3==1.0.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>config supervisor</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">echo_supervisord_conf &gt; /etc/supervisord.conf</span><br><span class="line"></span><br><span class="line">mkdir /etc/supervisor/conf.d</span><br><span class="line"></span><br><span class="line">/etc/supervisord.conf append below:</span><br><span class="line">[include]</span><br><span class="line">files = /etc/supervisor/conf.d/*.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>Supervisor manage program, /etc/supervisor/conf.d/xxxx.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[program:appname]</span><br><span class="line">command=/usr/local/redis/bin/redis-server /etc/redis.conf </span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">user=redis</span><br><span class="line">redirect_stderr=true</span><br></pre></td></tr></table></figure>
</li>
<li><p>add system service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -o /etc/rc.d/init.d/supervisord https://raw.githubusercontent.com/Supervisor/initscripts/master/redhat-init-equeffelec</span><br><span class="line">chmod 755 /etc/rc.d/init.d/supervisord</span><br><span class="line">chkconfig --add supervisord</span><br><span class="line">service supervisord start</span><br><span class="line">pkill supervisord</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>ref<br><a href="https://raw.githubusercontent.com/Supervisor/initscripts/master/redhat-init-equeffelec" target="_blank" rel="noopener">redhat-init-equeffelec</a></p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;ol&gt;
&lt;li&gt;&lt;p&gt;install python-pip&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span c
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Getting Started with osquery</title>
    <link href="https://t1ger.github.io/2018/12/11/Getting-Started-with-osquery/"/>
    <id>https://t1ger.github.io/2018/12/11/Getting-Started-with-osquery/</id>
    <published>2018-12-11T09:04:39.000Z</published>
    <updated>2018-12-11T09:38:20.000Z</updated>
    
    <content type="html"><![CDATA[<ol>
<li><p>How to install</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#for Centos7</span><br><span class="line">sudo rpm -ivh https://osquery-packages.s3.amazonaws.com/centos7/noarch/osquery-s3-centos7-repo-1-0.0.noarch.rpm</span><br><span class="line">sudo yum install osquery</span><br><span class="line"></span><br><span class="line">sudo cp /usr/share/osquery/osquery.example.conf /etc/osquery/osquery.conf</span><br><span class="line"># sudo service osqueryd start</span><br><span class="line">sudo systemctl start osqueryd</span><br><span class="line"># for CentOS6.x</span><br><span class="line">sudo rpm -ivh https://osquery-packages.s3.amazonaws.com/centos6/noarch/osquery-s3-centos6-repo-1-0.0.noarch.rpm</span><br><span class="line">sudo yum install osquery</span><br><span class="line"></span><br><span class="line"># default packages create the following structure</span><br><span class="line">/etc/osquery/</span><br><span class="line">/usr/share/osquery/osquery.example.conf</span><br><span class="line">/usr/share/osquery/lenses/&#123;*&#125;.aug</span><br><span class="line">/usr/share/osquery/packs/&#123;*&#125;.conf</span><br><span class="line">/var/log/osquery/</span><br><span class="line">/usr/lib/osquery/</span><br><span class="line">/usr/bin/osqueryctl</span><br><span class="line">/usr/bin/osqueryd</span><br><span class="line">/usr/bin/osqueryi</span><br></pre></td></tr></table></figure>
</li>
<li><p>How to use</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">osquery&gt; SELECT pid, name, path FROM processes LIMIT 1;</span><br><span class="line">+-----+------+------------+</span><br><span class="line">| pid | name | path       |</span><br><span class="line">+-----+------+------------+</span><br><span class="line">| 1   | init | /sbin/init |</span><br><span class="line">+-----+------+------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">osqueryi --json &quot;SELECT * FROM processes limit 1&quot;</span><br><span class="line">[</span><br><span class="line">  &#123;&quot;cmdline&quot;:&quot;/sbin/init&quot;,&quot;cwd&quot;:&quot;/&quot;,&quot;disk_bytes_read&quot;:&quot;150400097280&quot;,&quot;disk_bytes_written&quot;:&quot;31441313792&quot;,&quot;egid&quot;:&quot;0&quot;,&quot;euid&quot;:&quot;0&quot;,&quot;gid&quot;:&quot;0&quot;,&quot;name&quot;:&quot;init&quot;,&quot;nice&quot;:&quot;0&quot;,&quot;on_disk&quot;:&quot;1&quot;,&quot;parent&quot;:&quot;0&quot;,&quot;path&quot;:&quot;/sbin/init&quot;,&quot;pgroup&quot;:&quot;1&quot;,&quot;pid&quot;:&quot;1&quot;,&quot;resident_size&quot;:&quot;396000&quot;,&quot;root&quot;:&quot;/&quot;,&quot;sgid&quot;:&quot;0&quot;,&quot;start_time&quot;:&quot;0&quot;,&quot;state&quot;:&quot;S&quot;,&quot;suid&quot;:&quot;0&quot;,&quot;system_time&quot;:&quot;1440&quot;,&quot;threads&quot;:&quot;1&quot;,&quot;total_size&quot;:&quot;19356000&quot;,&quot;uid&quot;:&quot;0&quot;,&quot;user_time&quot;:&quot;230&quot;,&quot;wired_size&quot;:&quot;0&quot;&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>Features Overview</p>
</li>
</ol>
<ul>
<li><p>osqueryd<br>The high-performance and low-footprint distributed host monitoring daemon,osqueryd, allows you to schedule queries to be executed across your entire infrastructure. The daemon takes care of aggregating the query results over time and generates logs which indicate state changes in your infrastructure. You can use this to maintain insight into the security, performance, configuration, and state of your entire infrastructure. osqueryd’s logging can integrate into your internal log aggregation pipeline, regardless of your technology stack, via a robust plugin architecture.</p>
</li>
<li><p>osqueryi<br>The interactive query console, gives you a SQL interface to try out new queries and explore your operating system.With the power of a complete SQL language and dozens of useful tables built-in,osqueryi is an invaluable tool when performing incident response, diagnosing an systems operations problem, troubleshooting a performance issue, etc.</p>
</li>
<li><p>osquery<br>osquery is cross platform. Even though osquery takes advantage of very low-level operating system APIs, you can build and use osquery on Mac OS X, Ubuntu, Cent OS and other popular enterprise Linux distributions</p>
</li>
<li><p>plugin architecture<br>To assist with the rollout process, the osquery user guide has detailed documentation on internal deployment. osquery was built so that every environment specific aspect of the toolchain can be hot-swapped at run-time with custom plugins. Use these interfaces to deeply integrate osquery into your infrastructure if one of the several existing plugins don not suit your needs</p>
</li>
</ul>
<ol start="4">
<li>Logging<br>The osquery daemon uses a default filesystem logging plugin. Like the config, output from the filesystem plugin is written as JSON.Results from the query schedule are written to /var/log/osquery/osqueryd.results.log.<br>There are two types of logs<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. Status logs (info, warning, error, and fatal)</span><br><span class="line">2. Query schedule results logs</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>ref<br><a href="https://github.com/facebook/osquery" target="_blank" rel="noopener">osquery</a><br><a href="https://blog.spoock.com/2018/11/27/usage-of-osqueryd/" target="_blank" rel="noopener">使用osqueryd监控系统</a></p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;ol&gt;
&lt;li&gt;&lt;p&gt;How to install&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>How to install ModSecurity with Nginx</title>
    <link href="https://t1ger.github.io/2018/11/22/How-to-install-ModSecurity-with-Nginx/"/>
    <id>https://t1ger.github.io/2018/11/22/How-to-install-ModSecurity-with-Nginx/</id>
    <published>2018-11-22T08:45:00.000Z</published>
    <updated>2018-11-22T09:44:29.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文不打算写安装过程，具体安装参考<a href="https://github.com/SpiderLabs/ModSecurity/wiki/Compilation-recipes-for-v3.x" target="_blank" rel="noopener">这里</a><br>安装环境： centos6.8 </p>
<p>安装前准备,需要安装gcc4.8 和 更新autoconf，参考<a href="https://gist.github.com/tkuchiki/543e277a2f7221a7833a" target="_blank" rel="noopener">这里</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# curl -L -O http://ftp.gnu.org/gnu/autoconf/autoconf-2.69.tar.gz</span><br><span class="line">[root@localhost opt]# tar zxf autoconf-2.69.tar.gz</span><br><span class="line">[root@localhost opt]# cd autoconf-2.69</span><br><span class="line">[root@localhost opt]# yum install -y openssl-devel</span><br><span class="line">[root@localhost opt]# ./configure</span><br><span class="line">[root@localhost opt]# make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">[root@localhost opt]#  wget http://people.centos.org/tru/devtools-2/devtools-2.repo -O /etc/yum.repos.d/devtools-2.repo</span><br><span class="line">[root@localhost opt]#  yum install -y devtoolset-2-gcc-c++ devtoolset-2-binutils</span><br><span class="line">[root@localhost opt]#  source /opt/rh/devtoolset-2/enable</span><br></pre></td></tr></table></figure></p>
<p>规则下载<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /opt</span><br><span class="line">git clone https://github.com/SpiderLabs/owasp-modsecurity-crs.git</span><br><span class="line">cd owasp-modsecurity-crs/</span><br><span class="line">cp crs-setup.conf.example /usr/local/openresty/nginx/conf/crs-setup.conf</span><br><span class="line">cd rules</span><br><span class="line">cp REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf.example REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf</span><br><span class="line">cp RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf.example RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf</span><br></pre></td></tr></table></figure></p>
<p>添加modsecurity配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cp /opt/ModSecurity/modsecurity.conf-recommended /usr/local/openresty/nginx/conf/modsecurity.conf</span><br><span class="line">cp /opt/ModSecurity/unicode.mapping /usr/local/openresty/nginx/conf/unicode.mapping</span><br><span class="line">cp cp *.data /usr/local/openresty/nginx/conf/owasp/rules</span><br><span class="line">cp cp *.conf /usr/local/openresty/nginx/conf/owasp/rules</span><br><span class="line">vi modsecurity.conf</span><br><span class="line">最后添加</span><br><span class="line">Include /usr/local/openresty/nginx/conf/crs-setup.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/REQUEST-901-INITIALIZATION.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/REQUEST-905-COMMON-EXCEPTIONS.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/REQUEST-910-IP-REPUTATION.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/REQUEST-911-METHOD-ENFORCEMENT.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/REQUEST-912-DOS-PROTECTION.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/REQUEST-913-SCANNER-DETECTION.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/REQUEST-921-PROTOCOL-ATTACK.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/REQUEST-930-APPLICATION-ATTACK-LFI.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/REQUEST-931-APPLICATION-ATTACK-RFI.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/REQUEST-933-APPLICATION-ATTACK-PHP.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/REQUEST-941-APPLICATION-ATTACK-XSS.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/REQUEST-942-APPLICATION-ATTACK-SQLI.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/REQUEST-943-APPLICATION-ATTACK-SESSION-FIXATION.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/REQUEST-949-BLOCKING-EVALUATION.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/RESPONSE-950-DATA-LEAKAGES.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/RESPONSE-951-DATA-LEAKAGES-SQL.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/RESPONSE-952-DATA-LEAKAGES-JAVA.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/RESPONSE-953-DATA-LEAKAGES-PHP.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/RESPONSE-954-DATA-LEAKAGES-IIS.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/RESPONSE-959-BLOCKING-EVALUATION.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/RESPONSE-980-CORRELATION.conf</span><br><span class="line">Include /usr/local/openresty/nginx/conf/owasp/rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf</span><br><span class="line">#禁用某个规则方法</span><br><span class="line">#SecRuleRemoveById 949110</span><br><span class="line">#SecRuleRemoveById 920420</span><br><span class="line">#SecRuleRemoveById 931100</span><br></pre></td></tr></table></figure></p>
<p>默认只是检测，不拦截，可以修改配置，将<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SecRuleEngine DetectionOnly改为</span><br><span class="line">SecRuleEngine On</span><br></pre></td></tr></table></figure></p>
<p>编辑crs-setup.conf文件<br>默认ModSecurity不会阻挡恶意连接，只会记录在Log里。修改SecDefaultAction选项，默认开启阻挡<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sed -ie &apos;s/SecDefaultAction &quot;phase:1,log,auditlog,pass&quot;/#SecDefaultAction &quot;phase:1,log,auditlog,pass&quot;/g&apos; crs-setup.conf</span><br><span class="line">$ sed -ie &apos;s/SecDefaultAction &quot;phase:2,log,auditlog,pass&quot;/#SecDefaultAction &quot;phase:2,log,auditlog,pass&quot;/g&apos; crs-setup.conf</span><br><span class="line">$ sed -ie &apos;s/#.*SecDefaultAction &quot;phase:1,log,auditlog,deny,status:403&quot;/SecDefaultAction &quot;phase:1,log,auditlog,deny,status:403&quot;/g&apos; crs-setup.conf</span><br><span class="line">$ sed -ie &apos;s/# SecDefaultAction &quot;phase:2,log,auditlog,deny,status:403&quot;/SecDefaultAction &quot;phase:2,log,auditlog,deny,status:403&quot;/g&apos; crs-setup.conf</span><br></pre></td></tr></table></figure></p>
<p>nginx中增加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">modsecurity on;</span><br><span class="line">modsecurity_rules_file /usr/local/openresty/nginx/conf/modsecurity.conf;</span><br></pre></td></tr></table></figure>
<p>重启nginx<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service nginx restart</span><br></pre></td></tr></table></figure></p>
<p>打开modsecurity检测日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f /var/log/modsec_audit.log</span><br></pre></td></tr></table></figure></p>
<p>测试Modsecurity</p>
<p>在浏览器中访问默认首页，会看到Nginx默认的欢迎页<br>这时我们在网址后面自己加上正常参数，例如： <a href="http://localhost/?id=1" target="_blank" rel="noopener">http://localhost/?id=1</a> 。同样会看到Nginx默认的欢迎页：<br>接下来，我们在前面正常参数的基础上再加上 AND 1=1 ,整个请求变成： <a href="http://localhost/?id=1" target="_blank" rel="noopener">http://localhost/?id=1</a> AND 1=1<br>就会看到Nginx返回403 Forbidden的信息了，说明Modsecurity成功拦截了此请求。</p>
<p>出现的错误：</p>
<ol>
<li>未更新autoconf,更新即可<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ModSecurity]# sh build.sh </span><br><span class="line">libtoolize: putting auxiliary files in `.&apos;.</span><br><span class="line">libtoolize: copying file `./ltmain.sh&apos;</span><br><span class="line">libtoolize: putting macros in AC_CONFIG_MACRO_DIR, `build&apos;.</span><br><span class="line">libtoolize: copying file `build/libtool.m4&apos;</span><br><span class="line">libtoolize: copying file `build/ltoptions.m4&apos;</span><br><span class="line">libtoolize: copying file `build/ltsugar.m4&apos;</span><br><span class="line">libtoolize: copying file `build/ltversion.m4&apos;</span><br><span class="line">libtoolize: copying file `build/lt~obsolete.m4&apos;</span><br><span class="line">/usr/bin/m4:configure.ac:209: bad expression in eval: m4_esyscmd_s(cat headers/modsecurity/modsecurity.h | grep &quot;define MODSECURITY_MAJOR &quot; | awk &#123;&apos;print &apos;&#125; | sed &apos;s/\&quot;//g&apos;) + m4_esyscmd_s(cat headers/modsecurity/modsecurity.h | grep &quot;define MODSECURITY_MINOR &quot; | awk &#123;&apos;print &apos;&#125; | sed &apos;s/\&quot;//g&apos;)</span><br><span class="line">autom4te: /usr/bin/m4 failed with exit status: 1</span><br><span class="line">aclocal: autom4te failed with exit status: 1</span><br><span class="line">autoreconf: aclocal failed with exit status: 1</span><br><span class="line">/usr/bin/m4:configure.ac:209: bad expression in eval: m4_esyscmd_s(cat headers/modsecurity/modsecurity.h | grep &quot;define MODSECURITY_MAJOR &quot; | awk &#123;&apos;print &apos;&#125; | sed &apos;s/\&quot;//g&apos;) + m4_esyscmd_s(cat headers/modsecurity/modsecurity.h | grep &quot;define MODSECURITY_MINOR &quot; | awk &#123;&apos;print &apos;&#125; | sed &apos;s/\&quot;//g&apos;)</span><br><span class="line">autom4te: /usr/bin/m4 failed with exit status: 1</span><br><span class="line">autoheader: &apos;/usr/bin/autom4te&apos; failed with exit status: 1</span><br><span class="line">/usr/bin/m4:configure.ac:209: bad expression in eval: m4_esyscmd_s(cat headers/modsecurity/modsecurity.h | grep &quot;define MODSECURITY_MAJOR &quot; | awk &#123;&apos;print &apos;&#125; | sed &apos;s/\&quot;//g&apos;) + m4_esyscmd_s(cat headers/modsecurity/modsecurity.h | grep &quot;define MODSECURITY_MINOR &quot; | awk &#123;&apos;print &apos;&#125; | sed &apos;s/\&quot;//g&apos;)</span><br><span class="line">autom4te: /usr/bin/m4 failed with exit status: 1</span><br><span class="line">automake: autoconf failed with exit status: 1</span><br><span class="line">/usr/bin/m4:configure.ac:209: bad expression in eval: m4_esyscmd_s(cat headers/modsecurity/modsecurity.h | grep &quot;define MODSECURITY_MAJOR &quot; | awk &#123;&apos;print &apos;&#125; | sed &apos;s/\&quot;//g&apos;) + m4_esyscmd_s(cat headers/modsecurity/modsecurity.h | grep &quot;define MODSECURITY_MINOR &quot; | awk &#123;&apos;print &apos;&#125; | sed &apos;s/\&quot;//g&apos;)</span><br><span class="line">autom4te: /usr/bin/m4 failed with exit status: 1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>ref</p>
<p><a href="https://docs.nginx.com/nginx-waf/admin-guide/nginx-plus-modsecurity-waf-owasp-crs/" target="_blank" rel="noopener">Using the OWASP CRS with NGINX WAF</a><br><a href="https://fossies.org/linux/owasp-modsecurity-crs/INSTALL" target="_blank" rel="noopener">owasp-modsecurity-crs-3.0.2/INSTALL</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文不打算写安装过程，具体安装参考&lt;a href=&quot;https://github.com/SpiderLabs/ModSecurity/wiki/Compilation-recipes-for-v3.x&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;这里&lt;
    
    </summary>
    
    
  </entry>
  
</feed>
